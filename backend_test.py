#!/usr/bin/env python3
"""
Backend API Testing for Nova Scotia Tax Sale Aggregator
Focus on Production VPS Deployment Check-Updates Endpoint Testing
"""

import requests
import json
import sys
import re
import math
from datetime import datetime
import time

# Get backend URL from environment
import os
BACKEND_URL = os.environ.get('REACT_APP_BACKEND_URL', 'https://taxsale-automation.preview.emergentagent.com') + '/api'

# Production VPS URL for deployment testing
PRODUCTION_VPS_URL = 'https://taxsalecompass.ca/api'

def test_api_connection():
    """Test basic API connectivity"""
    print("üîó Testing API Connection...")
    try:
        response = requests.get(f"{BACKEND_URL}/", timeout=30)
        if response.status_code == 200:
            print("‚úÖ API connection successful")
            print(f"   Response: {response.json()}")
            return True, response.json()
        else:
            print(f"‚ùå API connection failed with status {response.status_code}")
            return False, None
    except Exception as e:
        print(f"‚ùå API connection error: {e}")
        return False, None

def test_deployment_status_endpoint():
    """Test GET /api/deployment/status endpoint"""
    print("\nüìä Testing Deployment Status Endpoint...")
    print("üéØ FOCUS: GET /api/deployment/status - should return current deployment status")
    
    try:
        response = requests.get(f"{BACKEND_URL}/deployment/status", timeout=30)
        
        print(f"   Status Code: {response.status_code}")
        
        if response.status_code == 200:
            try:
                data = response.json()
                print(f"   ‚úÖ SUCCESS: Deployment status endpoint accessible")
                print(f"   Response Data: {json.dumps(data, indent=2)}")
                
                # Check response structure
                required_fields = ['status', 'message', 'last_check']
                missing_fields = [field for field in required_fields if field not in data]
                
                if missing_fields:
                    print(f"   ‚ö†Ô∏è WARNING: Missing fields: {missing_fields}")
                else:
                    print(f"   ‚úÖ STRUCTURE: All required fields present")
                
                # Check if status shows "Error"
                status = data.get('status', '')
                if status.lower() == 'error':
                    print(f"   ‚ùå CRITICAL: Status shows 'Error' - this matches user report!")
                    print(f"   Error Message: {data.get('message', 'No message')}")
                    return False, data
                else:
                    print(f"   ‚úÖ STATUS: {status} (not 'Error')")
                    return True, data
                    
            except json.JSONDecodeError as e:
                print(f"   ‚ùå JSON DECODE ERROR: {e}")
                print(f"   Raw Response: {response.text[:500]}...")
                return False, {"error": "Invalid JSON response"}
        else:
            print(f"   ‚ùå HTTP ERROR: {response.status_code}")
            try:
                error_data = response.json()
                print(f"   Error Details: {error_data}")
                return False, error_data
            except:
                print(f"   Raw Response: {response.text[:200]}...")
                return False, {"error": f"HTTP {response.status_code}"}
                
    except Exception as e:
        print(f"   ‚ùå REQUEST ERROR: {e}")
        return False, {"error": str(e)}

def test_deployment_check_updates_endpoint():
    """Test POST /api/deployment/check-updates endpoint"""
    print("\nüîÑ Testing Deployment Check Updates Endpoint...")
    print("üéØ FOCUS: POST /api/deployment/check-updates - should check for available updates")
    
    try:
        response = requests.post(f"{BACKEND_URL}/deployment/check-updates", timeout=60)
        
        print(f"   Status Code: {response.status_code}")
        
        if response.status_code == 200:
            try:
                data = response.json()
                print(f"   ‚úÖ SUCCESS: Check updates endpoint accessible")
                print(f"   Response Data: {json.dumps(data, indent=2)}")
                
                # Check response structure
                required_fields = ['updates_available', 'message', 'checked_at']
                missing_fields = [field for field in required_fields if field not in data]
                
                if missing_fields:
                    print(f"   ‚ö†Ô∏è WARNING: Missing fields: {missing_fields}")
                else:
                    print(f"   ‚úÖ STRUCTURE: All required fields present")
                
                # Check updates availability
                updates_available = data.get('updates_available', False)
                print(f"   üì¶ Updates Available: {updates_available}")
                
                # Check if this matches user report of "Updates Available: No"
                if not updates_available:
                    print(f"   ‚úÖ MATCHES USER REPORT: No updates available")
                else:
                    print(f"   ‚ö†Ô∏è DIFFERS FROM USER REPORT: Updates are available")
                
                return True, data
                    
            except json.JSONDecodeError as e:
                print(f"   ‚ùå JSON DECODE ERROR: {e}")
                print(f"   Raw Response: {response.text[:500]}...")
                return False, {"error": "Invalid JSON response"}
        else:
            print(f"   ‚ùå HTTP ERROR: {response.status_code}")
            try:
                error_data = response.json()
                print(f"   Error Details: {error_data}")
                return False, error_data
            except:
                print(f"   Raw Response: {response.text[:200]}...")
                return False, {"error": f"HTTP {response.status_code}"}
                
    except Exception as e:
        print(f"   ‚ùå REQUEST ERROR: {e}")
        return False, {"error": str(e)}

def test_deployment_health_endpoint():
    """Test GET /api/deployment/health endpoint"""
    print("\nüè• Testing Deployment Health Endpoint...")
    print("üéØ FOCUS: GET /api/deployment/health - should return system health")
    
    try:
        response = requests.get(f"{BACKEND_URL}/deployment/health", timeout=120)
        
        print(f"   Status Code: {response.status_code}")
        
        if response.status_code == 200:
            try:
                data = response.json()
                print(f"   ‚úÖ SUCCESS: Deployment health endpoint accessible")
                print(f"   Response Data: {json.dumps(data, indent=2)}")
                
                # Check response structure
                required_fields = ['health_status', 'checked_at']
                missing_fields = [field for field in required_fields if field not in data]
                
                if missing_fields:
                    print(f"   ‚ö†Ô∏è WARNING: Missing fields: {missing_fields}")
                else:
                    print(f"   ‚úÖ STRUCTURE: All required fields present")
                
                # Check health status
                health_status = data.get('health_status', '')
                print(f"   üè• Health Status: {health_status}")
                
                # Analyze health status
                if health_status in ['excellent', 'good']:
                    print(f"   ‚úÖ HEALTH: System health is {health_status}")
                    return True, data
                elif health_status in ['poor', 'unknown']:
                    print(f"   ‚ö†Ô∏è HEALTH: System health is {health_status} - may contribute to deployment errors")
                    return False, data
                else:
                    print(f"   ‚ùå HEALTH: Unknown health status '{health_status}'")
                    return False, data
                    
            except json.JSONDecodeError as e:
                print(f"   ‚ùå JSON DECODE ERROR: {e}")
                print(f"   Raw Response: {response.text[:500]}...")
                return False, {"error": "Invalid JSON response"}
        else:
            print(f"   ‚ùå HTTP ERROR: {response.status_code}")
            try:
                error_data = response.json()
                print(f"   Error Details: {error_data}")
                return False, error_data
            except:
                print(f"   Raw Response: {response.text[:200]}...")
                return False, {"error": f"HTTP {response.status_code}"}
                
    except Exception as e:
        print(f"   ‚ùå REQUEST ERROR: {e}")
        return False, {"error": str(e)}

def test_deployment_verify_endpoint():
    """Test POST /api/deployment/verify endpoint"""
    print("\n‚úÖ Testing Deployment Verify Endpoint...")
    print("üéØ FOCUS: POST /api/deployment/verify - verify it's still working after previous fix")
    
    try:
        response = requests.post(f"{BACKEND_URL}/deployment/verify", timeout=30)
        
        print(f"   Status Code: {response.status_code}")
        
        if response.status_code == 200:
            try:
                data = response.json()
                print(f"   ‚úÖ SUCCESS: Deployment verify endpoint accessible")
                print(f"   Response Data: {json.dumps(data, indent=2)}")
                
                # Check response structure
                required_fields = ['deployment_valid', 'message', 'verified_at']
                missing_fields = [field for field in required_fields if field not in data]
                
                if missing_fields:
                    print(f"   ‚ö†Ô∏è WARNING: Missing fields: {missing_fields}")
                else:
                    print(f"   ‚úÖ STRUCTURE: All required fields present")
                
                # Check deployment validity
                deployment_valid = data.get('deployment_valid', False)
                message = data.get('message', '')
                
                print(f"   üîç Deployment Valid: {deployment_valid}")
                print(f"   üìù Message: {message}")
                
                if deployment_valid:
                    print(f"   ‚úÖ VERIFICATION: Deployment is valid")
                    return True, data
                else:
                    print(f"   ‚ùå VERIFICATION: Deployment verification failed")
                    # Check for specific error details
                    errors = data.get('errors', '')
                    if errors:
                        print(f"   üîç Error Details: {errors}")
                    return False, data
                    
            except json.JSONDecodeError as e:
                print(f"   ‚ùå JSON DECODE ERROR: {e}")
                print(f"   Raw Response: {response.text[:500]}...")
                return False, {"error": "Invalid JSON response"}
        else:
            print(f"   ‚ùå HTTP ERROR: {response.status_code}")
            try:
                error_data = response.json()
                print(f"   Error Details: {error_data}")
                return False, error_data
            except:
                print(f"   Raw Response: {response.text[:200]}...")
                return False, {"error": f"HTTP {response.status_code}"}
                
    except Exception as e:
        print(f"   ‚ùå REQUEST ERROR: {e}")
        return False, {"error": str(e)}

def analyze_deployment_error_source():
    """Analyze which endpoint is causing the deployment error status"""
    print("\nüîç Analyzing Deployment Error Source...")
    print("üéØ FOCUS: Identify which endpoint is returning error status causing 'Status: Error'")
    
    # Test all deployment endpoints
    status_result, status_data = test_deployment_status_endpoint()
    updates_result, updates_data = test_deployment_check_updates_endpoint()
    health_result, health_data = test_deployment_health_endpoint()
    verify_result, verify_data = test_deployment_verify_endpoint()
    
    print(f"\nüìä DEPLOYMENT ENDPOINTS ANALYSIS:")
    print(f"   GET /api/deployment/status: {'‚úÖ Working' if status_result else '‚ùå Error'}")
    print(f"   POST /api/deployment/check-updates: {'‚úÖ Working' if updates_result else '‚ùå Error'}")
    print(f"   GET /api/deployment/health: {'‚úÖ Working' if health_result else '‚ùå Error'}")
    print(f"   POST /api/deployment/verify: {'‚úÖ Working' if verify_result else '‚ùå Error'}")
    
    # Identify error sources
    error_sources = []
    
    if not status_result:
        error_sources.append("deployment/status")
        print(f"\n‚ùå ERROR SOURCE IDENTIFIED: /api/deployment/status")
        if 'status' in status_data and status_data['status'] == 'error':
            print(f"   üîç This endpoint returns status='error' - MATCHES USER REPORT!")
            print(f"   üìù Error Message: {status_data.get('message', 'No message')}")
    
    if not updates_result:
        error_sources.append("deployment/check-updates")
        print(f"\n‚ùå ERROR SOURCE IDENTIFIED: /api/deployment/check-updates")
    
    if not health_result:
        error_sources.append("deployment/health")
        print(f"\n‚ùå ERROR SOURCE IDENTIFIED: /api/deployment/health")
    
    if not verify_result:
        error_sources.append("deployment/verify")
        print(f"\n‚ùå ERROR SOURCE IDENTIFIED: /api/deployment/verify")
    
    # Check for "Last Deployment: Never" issue
    print(f"\nüïê CHECKING 'Last Deployment: Never' ISSUE:")
    
    # Check if status endpoint provides deployment history
    if status_result and 'last_deployment' in status_data:
        last_deployment = status_data.get('last_deployment')
        if not last_deployment or last_deployment == 'never':
            print(f"   ‚ùå CONFIRMED: last_deployment is '{last_deployment}' - MATCHES USER REPORT!")
        else:
            print(f"   ‚úÖ last_deployment: {last_deployment}")
    else:
        print(f"   ‚ö†Ô∏è No 'last_deployment' field found in status response")
    
    # Summary
    print(f"\nüìã ERROR SOURCE SUMMARY:")
    if error_sources:
        print(f"   ‚ùå Problematic endpoints: {', '.join(error_sources)}")
        print(f"   üîß These endpoints need investigation/fixing")
    else:
        print(f"   ‚úÖ All deployment endpoints are working")
        print(f"   ü§î Error may be in frontend interpretation or data format")
    
    return {
        'error_sources': error_sources,
        'status_result': status_result,
        'status_data': status_data,
        'updates_result': updates_result,
        'updates_data': updates_data,
        'health_result': health_result,
        'health_data': health_data,
        'verify_result': verify_result,
        'verify_data': verify_data
    }

def test_deployment_management_endpoints():
    """Comprehensive test of all deployment management endpoints"""
    print("\nüéØ COMPREHENSIVE DEPLOYMENT MANAGEMENT ENDPOINTS TEST")
    print("=" * 80)
    print("üéØ REVIEW REQUEST: Test all deployment management endpoints to identify error source")
    print("üìã SPECIFIC REQUIREMENTS:")
    print("   1. Test GET /api/deployment/status - should return current deployment status")
    print("   2. Test POST /api/deployment/check-updates - should check for available updates")
    print("   3. Test GET /api/deployment/health - should return system health")
    print("   4. Test POST /api/deployment/verify - verify it's still working after previous fix")
    print("   5. Identify why status shows 'Error' and 'Last Deployment: Never'")
    print("=" * 80)
    
    # Run comprehensive analysis
    analysis_results = analyze_deployment_error_source()
    
    # Final Assessment
    print("\n" + "=" * 80)
    print("üìä DEPLOYMENT MANAGEMENT ENDPOINTS - FINAL ASSESSMENT")
    print("=" * 80)
    
    error_sources = analysis_results['error_sources']
    all_working = len(error_sources) == 0
    
    print(f"‚úÖ Working Endpoints: {4 - len(error_sources)}/4")
    print(f"‚ùå Error Endpoints: {len(error_sources)}/4")
    
    # Detailed results
    print(f"\nüìã DETAILED RESULTS:")
    endpoints = [
        ('deployment/status', analysis_results['status_result']),
        ('deployment/check-updates', analysis_results['updates_result']),
        ('deployment/health', analysis_results['health_result']),
        ('deployment/verify', analysis_results['verify_result'])
    ]
    
    for endpoint, result in endpoints:
        status = "‚úÖ WORKING" if result else "‚ùå ERROR"
        print(f"   {status} - /api/{endpoint}")
    
    # Root cause analysis
    print(f"\nüîç ROOT CAUSE ANALYSIS:")
    
    if 'deployment/status' in error_sources:
        print(f"   ‚ùå CRITICAL: /api/deployment/status returns error - this causes 'Status: Error' in UI")
        status_data = analysis_results['status_data']
        if 'message' in status_data:
            print(f"      Error Message: {status_data['message']}")
    
    if not analysis_results['status_result']:
        print(f"   üîç Status endpoint issue likely causes 'Last Deployment: Never' display")
    
    # User report matching
    print(f"\nüìä USER REPORT MATCHING:")
    print(f"   Status: Error - {'‚úÖ CONFIRMED' if not analysis_results['status_result'] else '‚ùå NOT CONFIRMED'}")
    print(f"   Updates Available: No - {'‚úÖ CONFIRMED' if analysis_results['updates_result'] and not analysis_results['updates_data'].get('updates_available', True) else '‚ùå NOT CONFIRMED'}")
    print(f"   Last Deployment: Never - {'‚úÖ LIKELY' if not analysis_results['status_result'] else '‚ùå UNLIKELY'}")
    
    return all_working, analysis_results

def main():
    """Main test execution function - Focus on Deployment Management Endpoints"""
    print("üöÄ Starting Backend API Testing for Nova Scotia Tax Sale Aggregator")
    print("=" * 80)
    print("üéØ FOCUS: Test deployment management endpoints to identify error source")
    print("üìã REVIEW REQUEST: Test all deployment management endpoints to identify why deployment status shows 'Error'")
    print("üîç SPECIFIC TESTING REQUIREMENTS:")
    print("   1. Test GET /api/deployment/status - should return current deployment status")
    print("   2. Test POST /api/deployment/check-updates - should check for available updates")
    print("   3. Test GET /api/deployment/health - should return system health")
    print("   4. Test POST /api/deployment/verify - verify it's still working after previous fix")
    print("   5. Check what data each endpoint returns and identify why status shows 'Error'")
    print("   6. Verify the response formats match what the frontend expects")
    print("üéØ CONTEXT:")
    print("   - User reports deployment interface shows 'Status: Error', 'Updates Available: No', 'Last Deployment: Never'")
    print("   - We fixed the /api/deployment/verify timeout issue but other endpoints might have problems")
    print("   - Need to identify which endpoint is returning error status and why")
    print("=" * 80)
    
    # Test 1: Basic API connectivity
    api_connected, _ = test_api_connection()
    
    if not api_connected:
        print("\n‚ùå Cannot proceed without API connection")
        return False
    
    # Test 2: Deployment Management Endpoints (MAIN FOCUS)
    print("\nüéØ MAIN FOCUS: Deployment Management Endpoints Testing")
    all_working, analysis_data = test_deployment_management_endpoints()
    
    # Final Results Summary
    print("\n" + "=" * 80)
    print("üìä FINAL TEST RESULTS SUMMARY - Deployment Management Endpoints")
    print("=" * 80)
    
    if all_working:
        print(f"üéâ DEPLOYMENT MANAGEMENT ENDPOINTS: ALL WORKING!")
        print(f"   ‚úÖ All 4 deployment endpoints are functional")
        print(f"   ‚úÖ GET /api/deployment/status working properly")
        print(f"   ‚úÖ POST /api/deployment/check-updates working properly")
        print(f"   ‚úÖ GET /api/deployment/health working properly")
        print(f"   ‚úÖ POST /api/deployment/verify working properly")
        print(f"   ü§î Error may be in frontend interpretation or data format")
        
        # Show detailed success data
        error_sources = analysis_data.get('error_sources', [])
        
        print(f"\nüìä DETAILED SUCCESS METRICS:")
        print(f"   Working endpoints: {4 - len(error_sources)}/4")
        print(f"   Error endpoints: {len(error_sources)}/4")
        
        # Show response data for analysis
        print(f"\nüìã RESPONSE DATA ANALYSIS:")
        if analysis_data.get('status_result'):
            status_data = analysis_data.get('status_data', {})
            print(f"   Status Response: {json.dumps(status_data, indent=2)}")
        
        if analysis_data.get('updates_result'):
            updates_data = analysis_data.get('updates_data', {})
            print(f"   Updates Response: {json.dumps(updates_data, indent=2)}")
        
    else:
        print(f"‚ùå DEPLOYMENT MANAGEMENT ENDPOINTS: ISSUES IDENTIFIED")
        print(f"   ‚ùå Some deployment endpoints have problems")
        print(f"   üîß These endpoints need investigation/fixing")
        
        error_sources = analysis_data.get('error_sources', [])
        
        print(f"\nüìã ISSUES IDENTIFIED:")
        print(f"   Working endpoints: {4 - len(error_sources)}/4")
        print(f"   Error endpoints: {len(error_sources)}/4")
        
        # Show specific failures
        if error_sources:
            print(f"\n   ‚ùå PROBLEMATIC ENDPOINTS:")
            for endpoint in error_sources:
                print(f"      - /api/{endpoint}")
        
        print(f"\n   üîß RECOMMENDED ACTIONS:")
        print(f"      1. Check deployment script files exist and are executable")
        print(f"      2. Verify system health check scripts are working")
        print(f"      3. Check deployment status script output format")
        print(f"      4. Ensure proper permissions for deployment scripts")
        print(f"      5. Test deployment endpoints manually for detailed error messages")
    
    print("=" * 80)
    
    return all_working

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)